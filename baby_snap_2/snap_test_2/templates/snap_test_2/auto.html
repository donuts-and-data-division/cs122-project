
<!-- http://howcanisolve.com/33907/django-google-place-autocomplete-address-form -->

{% load staticfiles %}
<!DOCTYPE html>
<html>
    <head>
        <title>Course Catalog Search</title>
        <link rel="stylesheet" type="text/css" href="{% static "snap_test_2/css/mappage.css" %}" />
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
        <meta charset="utf-8">
        <link type="text/css" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500">
  </head>

  <body>
    <div id="map"></div>

    <div class="pac-card" id="pac-card">
        <div id="title">
          Find locations near:
        </div>
        <p></p>
  
            <div id="pac-container">
            <input id="pac-input" type="text"
                placeholder="Enter a location">
            </div>   
            <div id="pac-filters">
                <form id="form" onsubmit='return false'>
                    {% csrf_token %}
                    <table class="form">
                    <p> Type:<p> {% for field in form.retailer_type %}
                    {{ field }}
                    {% endfor %}</p>
                    <p>Cost:<p> {% for field in form.price %}
                    {{ field }}
                    {% endfor %}</p>
                    <p> Rating:<p> {% for field in form.rating %}
                    {{ field }}
                    {% endfor %}</p>
                    </table>
                    
                    <input type="submit"  value="Filter results" />
                </form>
              </div>
          <div id="listing">
            <table id="resultsTable">
             <tbody id="results"></tbody>
            </table>
         </div>
    </div>

    <div style="display: none">
      <div id="info-content">
        <table>
          <tr id="iw-name-row" class="iw_table_row">
            <td class="iw_attribute_name">Name:</td>
            <td id="iw-name"></td>
          </tr>
          <tr id="iw-address-row" class="iw_table_row">
            <td class="iw_attribute_name">Address:</td>
            <td id="iw-address"></td>
          </tr>
          <tr id="iw-phone-row" class="iw_table_row">
            <td class="iw_attribute_name">Telephone:</td>
            <td id="iw-phone"></td>
          </tr>
          <tr id="iw-rating-row" class="iw_table_row">
            <td class="iw_attribute_name">Rating:</td>
            <td id="iw-rating"></td>
          </tr>
          <tr id="iw-website-row" class="iw_table_row">
            <td class="iw_attribute_name">Website:</td>
            <td id="iw-website"></td>
          <tr>
            <td>
            <form id="groceries" action='groceries' method="get">
              {% csrf_token %}
              {{ groceries.as_p }}
              <input type="submit" id = "submit_groceries" name = "submit_groceries" value="Build Grocery List" />
            </form>
            </td>
          </tr>
        </table>
      </div>
    </div>
    
    <!--     SCRIPTS BEGIN  -->
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD2zsB1fPiX_9LUi7t_hyA_TaY3E2aAPQU&libraries=places"></script>
    <script src = {% static "snap_test_2/js/markers.js" %}></script>
    <script>
    var map
    var placeSearch, autocomplete, infoWindow;
    
    var markers = [];
    var MARKER_PATH = 'https://developers.google.com/maps/documentation/javascript/images/marker_green';

    $("#autocomplete").on('focus', function () {
          geolocate();
        });
    
    //Map initialization modified from:
    //https://developers.google.com/maps/documentation/javascript/examples/places-autocomplete
    function initialize() {
       console.log("I JUST RESET THE MAP")
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 12,
          center: new google.maps.LatLng(41.913154, -87.633311),
          });

        var card = document.getElementById('pac-card');
        var input = document.getElementById('pac-input');
        var types = document.getElementById('type-selector');
        var resultsBox = document.getElementById('listing');
        //map.controls[google.maps.ControlPosition.TOP_RIGHT].push(card);
        
      // Create the autocomplete object
       autocomplete = new google.maps.places.Autocomplete(
        document.getElementById('pac-input'));
        
        infoWindow = new google.maps.InfoWindow({
          content: document.getElementById('info-content')
        });

        // When the user selects an address from the dropdown,
       // populate the address fields in the form.
        google.maps.event.addListener(autocomplete, 'place_changed', function () {
          var place = autocomplete.getPlace();
          if (place.geometry.viewport) {
            map.fitBounds(place.geometry.viewport);
          } else {
            map.setCenter(place.geometry.location);
            map.setZoom(17);  
          }
               
           get_places();
        });

      
        $("#form").on("submit", function(){
          var data = $(this).serializeArray();
          console.log("serialized filter data: ", data);
          get_places(data);
        });

      }
        
      //https://simpleisbetterthancomplex.com/tutorial/2016/08/29/how-to-work-with-ajax-request-with-django.http
      // This site taught us how to use ajax with django.
      function get_places(data) {
          var bounds = map.getBounds().toJSON();
          var sw_lat = bounds.south;
          var sw_lon = bounds.west;
          var ne_lat = bounds.north;
          var ne_lon = bounds.east;  
          
      
          console.log("You are passing", data)
          
          $.ajax({
            url: '/ajax/get_places/',
            data: { 'data': data,
                    'sw_lat':sw_lat,
                    'sw_lon':sw_lon,
                    'ne_lat':ne_lat,
                    'ne_lon':ne_lon
                  },
            dataType: 'json',
            success: function(data) {
            console.log(data);

            var results = JSON.parse(data.data).features;
            placeMarkers(results);
            }
          });
        }
    
    initialize();
    </script>
  </body>
</html>